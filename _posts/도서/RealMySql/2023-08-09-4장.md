---
title: RealMySql 8.0 - 아키텍처
date: 2023-08-09
categories: [도서, RealMySql]
tags: [mysql, RealMySql, 아키텍처]
math: true
mermaid: true
---

## Mysql Architecture
![Image](https://github.com/phantom08266/TIL/assets/39672033/e1b73437-55e2-4a31-9a40-a3beaf7828e5)

Mysql 엔진 : SQL 인터페이스, SQL 파서, 옵티마이저 등의 기능을 제공하며, 커넥션 핸들러도 관리한다.(DBMS의 두뇌역할) <br>
스토리지 엔진 : 디스크에서 데이터를 일고 쓰는 역할을 담당한다. (DBMS의 손과 발을 담당) <br>
핸들러 API : Mysql 엔진이 스토리지 엔진에게 데이터를 읽어오거나 저장하도록 요청할 수 있는 요청 API들을 관리한다. <br>
```mysql
mysql> SHOW GLOBAL STATUS LIKE 'Handler%';
```

<br>

## Mysql 스레딩 구조
Mysql은 스레드 기반으로 동작한다. <br>
포그라운드, 백그라운드 스레드로 구분한다. <br>
```mysql
mysql> SELECT thread_id, name, type, processlist_user, processlist_host, FROM performance_schema.threads ORDER BY type, thread_id;
```

one_connection이란 스레드가실제 사용자의 요청을 처리하는 포그라운드 스레드이다. <br>

### 포그라운드 스레드

보통 사용자의 접속 수 만큼 포그라운드 스레드가 생성된다. <br>
사용자 요청이 들어오면 Mysql 서버는 포그라운드 스레드를 생성하고 이를 할당하여 사용자의 요청을 처리한다. <br>
요청이 완료되면 스레드는 종료하거나 스레드 캐시에 반환한다. (스레드 풀이랑 비슷한 개념같음) <br>
스레드 캐시는 일정 갯수 이상의 스레드만 존재하도록 유지하고 이를 thread_cache_size로 설정할 수 있다. <br>

### 백그라운드 스레드
백그라운드 스레드의 역할은 아래와 같다. <br>

1. Insert Buffer를 병합
2. 로그를 디스크로 저장
3. InnoDB버퍼 풀의 데이터를 디스크에 저장
4. 데이터를 버퍼로 읽어옴
5. 잠금이나 데드락을 모니터링

각각의 쓰기와 읽기 스레드 설정은 innodb_write_to_threads, innodb_read_io_threads로 설정할 수 있다. <br>
InnoDB에서는 데이터를 읽는 작업이 포그라운드 스레드가 처리하기 때문에 읽기 스레드는 많이 설정할 필요가 없으며, 쓰기 스레드는 넉넉하게 설정하는것이 좋다. <br>
MyISAM은 쓰기 작업에 버퍼링 기능이 없지만 InnoDB는 버퍼링 기능이 있어 데이터를 완전히 디스크로 저장할때까지 기다리지 않아도 된다. <br>

<br>

## 메모리 할당 및 사용구조

### 글로벌 메모리 영역 vs 로컬 메모리 영역

**[글로벌 메모리]** <br>
Mysql 서버가 실행되면서 운영체제로 부터 할당되고, 시스템 변수로 설정해둔 만큼 운영체제로부터 할당 받는다고 생각하는게 쉽다. <br>

포그라운드 스레드 수와 무관하며, 주로 하나의 메모리 공간에만 할당된다. <br>
여러개의 메모리 공간에 할당이 되어도 모든 스레드에 의해 공유 가능하다. <br>

- 테이블 캐시
- InnoDB 버퍼 풀
- InnoDB 어댑티브 해시 인덱스
- InnoDB 리두 로그 버퍼

<br>

**[로컬 메모리]** <br>
클라이언트와 Mysql 서버와의 커넥션을 세션이라 불리며, 이 세션을 처리하기 위해 할당한 메모리 영역을 로컬 메모리 영역이라 한다. <br>
각 포그라운드 스레드 별로 스레드가 독립적으로 할당되며, 해당 메모리는 절대 공유하지 않는다. <br>

- 정렬 버퍼
- 조인 버퍼
- 바이너리 로그 캐시
- 네트워크 버퍼


<br>

## 플러그인 스토리지 엔지 모델

Mysql은 플러그인 모델이다. <br>
즉 다양한 기능들을 플러그인으로 제공하고, 필요한 기능들만 설치해서 사용할 수 있다. <br>
심지어 스토리지 엔진까지 플러그인처럼 선택하고 사용할 수 있다. <br>

이 책을 읽고 '하나의 쿼리작업을 수행하기 위해서 Mysql 엔진 영역에서 동작하는지, 스토리지 엔진에서 동작하는지' 구분할 수 있어야 한다. <br>

```mysql
# mysqld 서버가 지원해주는 스토리지 엔진은 아래 명령어로 확인 가능하다.
mysql> SHOW ENGINES;

# 플러그인 확인
mysql> SHOW PLUGINS;
```

Mysql 플러그인 API가 매뉴얼에 있으므로 원하는 기능들을 만들어볼 수도 있다. <br>

<br>

## 
 
