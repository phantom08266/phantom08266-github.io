---
title: RealMySql 8.0 - 데이터 암호화
date: 2023-09-10
categories: [도서, RealMySql]
tags: [mysql, RealMySql, 암호화]
math: true
mermaid: true
---


Mysql 서버의 암호화 기능은 디스크 입출력을 할때만 암호화 처리를 한다. 
즉 Mysql 서버 Innodb I/O레이어에서만 데이터의 암호화 및 복호화가 이루어지기 때문에 Mysql내부와 사용자 입장에서는 달라지는게 없다. 이를 TDE(Transparent Data Encryption)이라고 한다.


## 2단계 키 관리
Mysql 서버의 TDE에서 암호화 키는 키링 플러그인에 의해 관리된다.
Mysql 8.0에서 주로 keyring_file플러그인만 무료로 사용가능하고 여러 엔터프라이즈 환경에서 사용가능한 킹링 플러그인도 있다.


Mysql서버는 HashiCorp Vault 같은 외부 키 관리 솔루션에 keyring_vault 파일을 받아 마스터 키를 가져오거나 keyring_file을 통해 내부 디스크에 있는걸 가져오는 방식으로 마스터키를 가져올 수 있다.

가져온 마스터키를 가지고 테이블스페이스 키를 만들게 되는데 이 키를 암호화된 테이블 헤더에 할당한다. 
테이블스페이스 키는 마스터키를 기반으로 만들게 되었으니 마스터키를 갱신할때 마다 같이 테이블스페이스 키도 복호화되어 다시 변경된 마스터키로 암호화된다. 


마스터키를 갱신하고 테이블스페이스 키를 변경하는 절차와 변경된 테이블스페이스키를 실제 테이블에 반영하는 절차를 2단계로 나눈 이유는 데이터를 복호화하고 암호화하는데 많은 리소스가 필요하고 시스템 부하를 최대한 줄이기 위해서이다. 

사용되는 암호화 알고리즘은 
- AES-256 ECB : 테이블스페이스 키 암호화 알고리즘
- AES-256 CBC : 데이터 파일 암호화 알고리즘


## 암호화와 성능
암호화는 디스크 입출력을 할때 동작하기 때문에 InnoDB 버퍼 풀에 적재되어있는 데이터는 모두 복호화 되어있는 상태이다. 
따라서 InnoDB 버퍼 풀에 이미 적재된 데이터라면 암호화한 데이터와 그렇지 않는 데이터의 처리 성능은 동일하다.

### 주요 성능 포인트 
물론 암호화와 복호화 과정을 거치기 때문에 암호화된 테이블에 데이터를 조회하거나 수정할때 성능 문제가 발생할 수 있다. 
하지만 데이터 변경 및 저장같은 경우에는 Mysql서버가 백그라운드 스레드로 동작하여 수행하기 때문에 사용자 입장에서는 쿼리지연을 느낄 수 없다. 다만 새로운 데이터를 버퍼 풀로 조회할 경우에는 복호화 지연이 발생하여 성능에 영향을 줄 수 있다.


### 메모리 효율측면
암호화를 하면 데이터 용량을 걱정할 수 있는데 Mysql에서 사용하고 있는 AES 암호화 알고리즘은 평문과 동일한 크기를 가지기 때문에 문제가 없다. 따라서 암호화를 적용했다고 해서 InnoDB 버퍼 풀의 효율이 달라지거나 메모리 사용 효율이 떨어지지 않는다.


### 암호화가 먼저냐 압축이 먼저냐
테이블에 압축과 암호화가 둘다 적용되어야 할때 Mysql은 압축부터 진행하고, 암호화를 마지막으로 수행한다.

1. InnoDB버퍼 풀에는 압축된 데이터와 그렇지 않는 데이터가 존재할 수 있다고 배웠다. 반대로 암호화는 InnoDB 버퍼풀에 적재할때는 복호화가 되어있어야 하는데 만약 순서가 변경되어 암호화를 먼저 진행한다고 하면 InnoDB버퍼 풀에서 데이터 조작을 할 경우 암호화를 해야한다는 말이 되기 때문에 성능문제가 발생한다.
2. 일반적으로 암호화를 사용할때 랜덤한 바이트배열을 사용하는데 이게 암호화 효율을 떨어뜨린다고 한다. 


## 암호화와 복제
Mysql 서버를 복제해서 레플리카 서버를 만들때 데이터를 모두 동기화 하기 때문에 마스터키, 테이블스페이스 키도 복제가 된다고 생각할 수 있다. 하지만 복제가 안되며 원칙적으로 레플리카 서버에 대한 마스터키도 새로 발급해야 하고 이로인해 테이블스페이스 키도 새로 암호화해서 할당해야한다. 

~~~shell
ALTER INSTANCE ROTATE INNODB MASTER KEY
~~~
해당 명령어를 통해서 마스터키를 변경할 수 있는데 이를 통해 소스서버, 레플리카 서버 둘다 각각 수행해야 한다.


## keyring_file 플러그인 설치
TDE 암호화 키 관리 플러그인 방식으로 Mysql 커뮤니티에서는 keyring_file플러그인을 무료로 사용가능하도록 지원한다. 
해당 플러그인은 디스크에 마스터키를 저장하는 방식인데 해당 방식은 운영환경에서는 적합하지 않는다. (해당 마스터키 파일을 털리면 끝남..)

따라서 Percona Server 에서 지원하는 HashiCorp Vault를 연동하는 것을 고려해 보는것도 좋은 방안이다. 

Mysql서버는 부팅할때 마스터키를 메모리에 로딩한 후 사용함으로 서버가 부팅된 후 파일을 제거해도 동작에는 문제없다. 

 my.cnf 설정파일 수정

>  early-plugin-load = keyring_file.so <br> 
>  keyring_file_data = /경로 / tde_master.key

위 설정방식을 통해 keyring_file 플러그인을 위한 라이브러리를 명시하고(keyring_file.so), 마스터키를 저장할 키링 파일의 경로를 명시해주면 끝난다.

~~~shell
#해당 명령어를 통해서 플러그인이 잘 초기화가 되었는지 확인한다.
Mysql> Show plugins;      
#테이블이 잘 생성되었는지 확인하고 아직 마스터키를 사용한적이 없기 때문에 실제 키링 파일의 내용은 비어있다.
Linux> ls -alh tde_master.key  
#암호화 기능을 사용하는 테이블을 생성하거나 로테이션 쿼리를 실행하면 키링 파일의 마스터키가 초기화되는 것을 볼 수 있다.
Mysql> ALTER INSTANCE ROTATE INNODB MASTER KEY;     
~~~
