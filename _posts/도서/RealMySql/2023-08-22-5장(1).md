---
title: RealMySql 8.0 - 트랜잭션과 락
date: 2023-08-22
categories: [도서, RealMySql]
tags: [mysql, RealMySql, 트랜잭션, 락]
math: true
mermaid: true
---

트랜잭션이란?
여러 작업을 하나의 단위로 묶어서 처리하는 개념으로 부분처리가 되지 않도록 처리하는 개념이다. 

Lock(잠금) : 동시성을 제어하기 위한 기능(여러 커넥션 중 하나의 커넥션만 처리할 수 있도록 하는 기능)
트랜잭션: 데이터의 정합성을 보장하기 위한 기능(정합성은 실패를 하면 다같이 실패처리하는 것을 말한다.)

격리수준 : 하나의 트랜잭션 또는 여러 트랜잭션 간의 작업내용을 공유하고 차단할지를 결정하는 것.


트랜잭션의 범위는 최소화하는 것이 좋다.
물론 비즈니스에 따라서 하나의 트랜잭션으로 처리되어야 하는 것이라면 어쩔 수 없지만 대부분 그렇지 않은 트랜잭션과 별 상관없는 로직도 하나의 트랜잭션으로 묶이는 경우가 있기 때문에 이를 경계해야 한다. 
또한 반드시 외부 통신이 있는 경우 등에는 트랜잭션에서 분리해야 한다. 안그러면 DBMS에 높은 부하를 줄 수 있다.


## Mysql 엔진 Lock

Mysql에서는 Lock을 크게 두가지로 나눈다.
- 스토리지 엔진 Lock
- Mysql 엔젠 Lock(스토리지 엔진 Lock을 제외한 모든 Lock을 말한다.)

당연한 말이지만 Mysql엔진 Lock은 모든 스토리지에 영향을 주지만 스토리지 엔진의 Lock은 서로다른 스토리지엔진에게 영향을 주지 않는다.


### 글로벌 락

	> FLUSH TABLES WITH READ LOCK

위 명령으로 글로벌 락을 획득할 수 있다. 하지만 이는 모든 테이블들에 Lock을 거는 것이므로 서비스중인 디비에서 사용하는 것은 지양해야 하며, mysqldump를 뜰때 옵션에 따라 글로벌 락이 적용될 수 있으니 확인해봐야 한다. 

또한 글로벌 락 적용 전에 Select가 오래 잡고있는 트랜잭션이 있는 경우 해당 트랜잭션이 종료될때까지 기다렸다가 글로벌락이 동작한다. 즉 선행작업이 완료된 뒤 동작한다. 


요즘은 트랜잭션을 지원하는 InnoDB를 스토리지 엔진으로 많이 사용하고 MyISAM, Memory 스토리지 엔진을 사용하지 않는다. 따라서 글로벌 락보다 조금 가벼운 락을 찾게 되었고 그래서 나온 개념이 8.0부터 나온 백업 락 이다.

	> LOCK INSTANCE FOR BACKUP;
	> UNLOCK INSTANCE;

백업락은 테이블의 데이터 변경, 조회는 허용하지만 그 외는 허용하지 않는다.
	- 데이터베이스 및 테이블 추가 및 변경
	- REPAIR TABLE 과 OPTIMIZE TABLE 명령
	- 사용자 관리 및 비밀번호 변경

따라서 글로벌 락보다 가볍고 주로 레플리카 서버에 적용한다. 
또한 Xtrabackup이나 Enterprise Backup과 같은 백업 툴들을 위해서 백업락은 DDL같은 변경이 일어나면 일시 중지 하는 기능 등이 있다.

### 테이블 락
테이블락도 역시 서비스중인 DB 테이블에서는 사용을 지양해야 한다.

	> LOCK TABLE table_name [READ | WRITE]
	> UNLOCK TABLE

InnoDB, MyISAM, Memory 에서도 테이블의 데이터를 변경할때 묵시적으로 테이블락이 실행된다.
다만 InnoDB는 스토리지 엔진차원에서 레코드 기반 락을 지원하기 때문에 테이블락이 설정되지만 데이터를 변경(DML)쿼리는 무시되고 스키마를 변경하는 쿼리(DDL)의 경우에만 영향을 준다.


### 네임드 락
임의의 문자열에 대해 Lock을 거는 방식이다. 
테이블이나 특정 레코드가 아닌 그냥 사용자가 지정한 문자열에 Lock을 거는 것이다.

	> SELECT GET_LOCK('문자열', 2);       # 2초동안 잠금
	> SELECT IS_FREE_LOCK('문자열');      #  문자열이 잠금되어있는지 확인
	> SELECT RELEASE_LOCK('문자열');      # 잠금을 반납한다.
	> SELECT RELEASE_ALL_LOCKS();       # 8.0부터 가능하며 모든 네임드락을 해제해준다.



### 메타데이터 락
데이터베이스 객체(테이블, 뷰 등)의 이름이나 구조를 변경하는 경우 자동으로 획득되는 락이다.
따라서 명시적으로 작성하는 것이 아니다. 
	Ø  RENAME TABLE ta_a TO ta_b;       # ta_a에서 ta_b로 이름을 변경할 경우 메타데이터 락이 획득된다.

테이블 이름을 변경하는 경우 주의사항이 있다.

테이블 이름을 변경할때 한꺼번에 실행해야지 나눠서 실행하면 Table not found가 발생할 수 있다. 
> RENAME TABLE rank TO rank_backup, rank_new TO rank;
